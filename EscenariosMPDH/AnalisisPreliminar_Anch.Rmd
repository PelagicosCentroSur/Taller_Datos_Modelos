---
title: "Análisis preliminar anchoveta"
author: "María José Zúñiga"
date: "2023-06-20"
output: pdf_document
---

```{r global-options, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=FALSE, message=FALSE,collapse=TRUE,fig.align="center",fig.pos="h!")
```


```{r results='hide'}
## Librerías requeridas
 paquetes <- c("stringr", "tidyverse", "kableExtra","ggplot2","ggthemes",
               "patchwork","dplyr","reshape","here","pdftools","ggpubr","tidyr")
 lapply(paquetes, require, character.only = TRUE)
 
```


```{r echo=FALSE}
## Directorios de trabajo
dir.0   <- here() 
dir.s0   <- here("codigo_admb_modificado_A") 
dir.fun <- here("funciones") 
dir.Rdata<-here("Rdata")
```


```{r echo=FALSE}
## Cargar funciones
source(here(dir.fun,"functions.R")) 
source(here(dir.fun,"Fn_CrearRdata.R"))
source(here(dir.fun,"Fn_Data.frame.R"))
source(here(dir.fun,"Fn_Figuras.R"))
source(here(dir.fun,"Fn_Tablas.R"))
source(here(dir.fun,"Fn_PBRs.R")) 
source(here(dir.fun,"removefile.R"))										   									
```

# Revisión de los datos

```{r eval=FALSE, include=F}
## Compilar y ejecutar modelo ADMB
setwd(dir.s0)
#para mac
system("~/admb-12.2/admb MAE323m")
system("./MAE323m")

source(here("funciones","removefile.R"))
removefileadmb(dir.s0,"MAE323m") 

```

```{r}
NombrecarpetaEsc<-"Sensibilidad_mpdh2023_Anch"
# 2. Crear un nuevo directorio  donde se encuentran los análisis de sensibilidad
dir.esc <- here(NombrecarpetaEsc)
dir.create(path=dir.esc, showWarnings = TRUE, recursive = TRUE)
file.copy(c(here("codigo_admb_modificado_A","MAE323m.dat"),
            here("codigo_admb_modificado_A","MAE323m.tpl")),dir.esc)


# Caso base
data1        <- lisread(here("codigo_admb_modificado_A","MAE323m.dat")) 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1

#Datos para escenarios

mpdh_dens<-c(rep(0,6),
             152,658,306,640,0,5649,894,152,337,254,
             48,90,426,870,331,0,372,489,1224,262,0)

cvmpdh_dens<-c(rep(0.3,6),
               .140,.171,.211,.210,.30,.179,.184,.189,.359,
               .193,.208,.199,.187,.185,.177,.30,.185,.184,.172,.193,.30)

dtmpdh<-c(rep(0.16,6),
          .13,.15,.14,.14,.16,.16,.18,.18,.20,.23,.27,
          .24,.19,.24,.19,.16,.19,.14,.24,.27,.20) # dt variable

# cvreclas<-c(rep(0.30,6),
#             .14,.15,.07,.20,.10,.08,.11,.25,.12,.07,.28,
#             .14,.19,.05,.14,.16,.075,.166,.063,.030,.070,NA,NA)
# 
# cvpela<-c(rep(0.30,14),
#           .22,.05,.13,.10,.15,.10,.30,.075,.11,.13,.052,.033,.05,NA,NA)
# 
# cvmpdh<-c(rep(0.30,8),
#           .289,.30,.368,.441,.30,.380,1.050,.578,.494,.390,
#           1.650,.605,.30,.145,.139,.30,.251,.30,.261,NA)

```


```{r eval=FALSE}

#------------------------------------------
#S1 CV = 100, dt fijo y q fijo
dat1         <- data1
dat1$Ind[,7] <- 100 # cv mpdh
dat1$Ind[,10] <- 0.16 # dt fijo
dat1$nbloq_qmph <- 1 # bloques q
dat1$ano_inicio_nbloq_qmph <- 1997 # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m1.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m1.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)
#------------------------------------------
#S2 CV = 100, dt variable y q fijo
dat1         <- data1
dat1$Ind[,7] <- 100 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 1 # bloques q
dat1$ano_inicio_nbloq_qmph <- 1997 # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m2.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m2.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)
#------------------------------------------
#S3 CV = 100, dt variable y q bloque
dat1         <- data1
dat1$Ind[,7] <- 100 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2018) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m3.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m3.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)
#------------------------------------------
#S4 CV = 0.3, dt variable y q bloque
dat1         <- data1
dat1$Ind[,7] <- 0.3 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m4.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m4.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)

#------------------------------------------
#S5 CV = 0.3, dt variable y q bloque
dat1         <- data1
dat1$Ind[,7] <- 0.15 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m5.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m5.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)
#------------------------------------------
#S6 CV = 0.5, dt variable y q bloque
dat1         <- data1
dat1$Ind[,7] <- 0.5 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m6.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m6.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)

#------------------------------------------
#S7 CV reclas=100, CV mph = 0.3, dt variable y q bloque
dat1         <- data1
dat1$Ind[,3] <- 100 # cv reclas
dat1$Ind[,5] <- 0.3 # cv pelaces
dat1$Ind[,7] <- 0.5 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m7.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m7.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)

#------------------------------------------
#S8 CV pelaces=100, CV reclas=0.30, CV mph = 0.3, dt variable y q bloque
dat1         <- data1
dat1$Ind[,3] <- 0.3 # cv reclas
dat1$Ind[,5] <- 100 # cv pelaces
dat1$Ind[,7] <- 0.3 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m8.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m8.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)

#------------------------------------------
#S9 CV = 0.5, dt variable y q bloque
dat1         <- data1
dat1$Ind[,3] <- 0.25 # cv reclas
dat1$Ind[,5] <- 0.15 # cv pelaces
dat1$Ind[,7] <- 0.3 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m9.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m9.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)

#------------------------------------------
#S10 mph=densidad, CV = 0.3, dt variable y q bloque 
dat1         <- data1
dat1$Ind[,6] <- mpdh_dens
dat1$Ind[,7] <- 0.3 # cv mpdh
dat1$Ind[,10] <- dtmpdh
dat1$nbloq_qmph <- 3 # bloques q
dat1$ano_inicio_nbloq_qmph <- c(1997,2010,2015) # año inicio q

writeData(here(NombrecarpetaEsc,"MAE323m10.dat"), dat1, append=F)
file.rename(here(NombrecarpetaEsc,"MAE323m.tpl"),here(NombrecarpetaEsc,"MAE323m10.tpl"))
file.copy(here("codigo_admb_modificado_A","MAE323m.tpl"),dir.esc)


dat1         <- data1

```


```{r eval=FALSE, include=F}
## Compilar y ejecutar modelo ADMB

setwd(here(NombrecarpetaEsc))

nesc<-9
for(i in 1:nesc){
#para mac
system(paste("~/admb-12.2/admb MAE323m",i,sep=""))
system(paste("./MAE323m",i,sep=""))

source(here("funciones","removefile.R"))
removefileadmb(here(NombrecarpetaEsc),paste("MAE323m",i,sep="")) 
}

```


```{r eval=F, include=F}
source(here(dir.fun,"Fn_Verosimilitud.R"))
logRo    <- 10.2469964776
#factor    <- seq(0.2,2,0.08)
priorRo  <- seq(9.5,11.1,0.06)

for(i in 1:nesc){
Verosimilitud(paste("MAE323m",i,sep=""),
              dir.0,
              dir.esc,
              paste("/PerfilVeroA",i,sep=""),
              logRo,
              priorRo,
              l_log_Ro=239,
              l_opt_Ro=290,
              l_Fase_desRt=293,
              system="mac") 
}

```


```{r eval=F}
## `Rdata_perfil` genera Rdata para perfil de verosimilitud
for(i in 1:nesc){
source(here(dir.fun,"Fn_CrearRdata.R"))
dirperfil<-here(dir.0,paste("PerfilVeroA",i,sep=""))
dfperfil<-Rdata_perfil(dirperfil,admb=paste("/MAE323m",i,sep=""),dir.Rdata,paste("Hito 2a",i,sep=""))}

```


```{r eval=F, include=F}
# `Fn_Retrospectivo.R`
nesc<-9
source(here(dir.fun,"Fn_Retrospectivo.R"))
for(i in 1:nesc){
Retrospectivo(paste("MAE323m",i,sep=""),
              dir.0,
              dir.esc,
              paste("/RetroA",i,sep=""),
              system="mac") 
}
```




```{r}
nesc<-9
#indicadores
nyears<-dat1$nanos
years<-dat1$Ind[,1]

mpdh_obs<-dat1$Ind[,6];mpdh_obs[mpdh_obs==0]<-NA
reclas_obs<-dat1$Ind[,2];reclas_obs[reclas_obs==0]<-NA
pelaces_obs<-dat1$Ind[,4];pelaces_obs[pelaces_obs==0]<-NA

mpdh_pred<-matrix(nrow=nyears,ncol=nesc)
reclas_pred<-matrix(nrow=nyears,ncol=nesc)
pelaces_pred<-matrix(nrow=nyears,ncol=nesc)

resmph <-matrix(nrow=nyears,ncol=nesc)
  resrecl<-matrix(nrow=nyears,ncol=nesc)
  respela<-matrix(nrow=nyears,ncol=nesc)
  
  RMSE_mph<-rep(0,nesc)
  RMSE_reclas<-rep(0,nesc)
  RMSE_pelaces<-rep(0,nesc)
  
BD<-matrix(nrow=nyears,ncol=nesc)
Rt<-matrix(nrow=nyears,ncol=nesc)
Ft<-matrix(nrow=nyears,ncol=nesc)
escenarios<-rep(0,nesc)
for(i in 1:nesc){
rep1.1<- reptoRlist(paste(here(NombrecarpetaEsc),"/MAE323m",i,".rep",sep=""))

mpdh_pred[,i]<- rep1.1$mphpred
reclas_pred[,i]<-rep1.1$reclaspred
pelaces_pred[,i]<-rep1.1$pelacespred

resmph[,i] <-(log(mpdh_pred[,i])-log(mpdh_obs))
resrecl[,i]<-(log(reclas_pred[,i])-log(reclas_obs))
respela[,i]<-(log(pelaces_pred[,i])-log(pelaces_obs))

RMSE_mph[i]<-round(sqrt(sum((resmph[,i]^2),na.rm=TRUE)/18),2)
RMSE_reclas[i]<-round(sqrt(sum((resrecl[,i]^2),na.rm=TRUE)/23),2)
RMSE_pelaces[i]<-round(sqrt(sum((respela[,i]^2),na.rm=TRUE)/15),2)

BD[,i]<-rep1.1$SSB
Rt[,i]<-rep1.1$Reclutas
Ft[,i]<-rep1.1$Ftot


escenarios[i]<-paste("S",i,sep="")
}

colnames(mpdh_pred)<-escenarios
colnames(reclas_pred)<-escenarios
colnames(pelaces_pred)<-escenarios

colnames(resmph)<-escenarios
colnames(resrecl)<-escenarios
colnames(respela)<-escenarios

colnames(BD)<-escenarios
colnames(Rt)<-escenarios
colnames(Ft)<-escenarios

```

```{r eval=F}

for(i in 1:nesc){
## `Rdata_retroanalitico` genera Rdata para Retrospectivo analítico
dirRDretroA<-here(dir.0,paste("RetroA",i,sep=""))
# list.files(dirRDretroA,pattern=".rep")
RDretroA<-Rdata_retroanalitico2(paste("Hito 2a",i,sep=""),dirRDretroA,dir.Rdata) #crea Rdata
Rdata_retroA<-here(dir.Rdata,paste("RetroA",i,sep=""))  # path Rdata
}
```


# Revisión de los datos del Método de Producción Diaria de Huevos (MPDH)

```{r}
data1        <- lisread(here("Sensibilidad_mpdh2023_Anch","MAE323m1.dat")) 
names(data1) <- str_trim(names(data1), side="right")
dat1         <- data1
rep1         <- reptoRlist(here("Sensibilidad_mpdh2023_Anch","MAE323m1.rep"))
std1         <- read.table(here("Sensibilidad_mpdh2023_Anch","MAE323m1.std"),header=T,sep="",na="NA",fill=T) 
```


```{r}
Datos<-dat1$Ind[,c(1:7,10)] %>% data.frame()
names(Datos)<-c("year","Crucero_verano","cv_V","Crucero_otoño","cv_O","Crucero_huevos","cv_H","dt_H")

caption1<-"\\label{tab1}Índices de abundancia con los coeficientes de variación utilizados en el modelo de evaluación de stock de anchoveta centro-sur."

Datos %>% kbl(booktabs = T,format = "latex",position="h!", align='l',escape=F,
col.names=linebreak(c("Año","Crucero\nverano","cvV","Crucero\notoño","cvO","Crucero\nhuevos","cvH","dtH"), align='c'),caption=caption1) %>%  
kable_styling(latex_options = c("striped", "hover","condensed"),
full_width = FALSE,font_size=9)
```


\newpage

```{r fig.height=2.5,fig.width=5,fig.cap="\\label{Fig1}Índices de biomasa estimados en los cruceros de verano, otoño y huevos."}
Datos1<-Datos[,c(1,2,4,6)] %>% melt(id="year")
Datos1[Datos1==0]<-NA

ggplot(Datos1,aes(x=year,y=value/1000000))+xlim(2000,2024)+
  geom_line(aes(color=variable))+geom_point(aes(color=variable),size=2)+
  scale_color_manual(name="Índices de biomasa",
                     labels=c("Crucero Verano","Crucero Otoño","Crucero Huevos"),
                     values=c("black","red","green"))+
  ylab("Biomasas (millones de t)")+xlab("Años")+ggtitle("Anchoveta centro-sur")+
  theme_bw(base_size=9.5)
```




```{r}
names_ind<- c('Crucero_verano','Crucero_otoño','Crucero_huevos') 
  #observados 
  years<-rep1$years
  reclasobs     <-rep1$reclasobs %>% na_if(0)
  pelacesobs    <-rep1$pelacesobs %>% na_if(0)
  mphobs        <-rep1$mphobs %>% na_if(0)
  #data.frame observados 
  indobs  <- data.frame(reclasobs,pelacesobs,mphobs) %>% 
                     magrittr::set_colnames(names_ind) %>%
                     mutate(Asesoria="Hito 2",type='observado',yrs= years) %>% 
                     melt(id.var=c('yrs','type', 'Asesoria'))  
  #predichos
  reclaspred     <-rep1$reclaspred 
  pelacespred    <-rep1$pelacespred 
  mphpred        <-rep1$mphpred
  #data.frame predichos
  indpred  <- data.frame(reclaspred,pelacespred,mphpred) %>% 
                      magrittr::set_colnames(names_ind) %>%
                      mutate(Asesoria="Hito 2",type='predicho',yrs= years) %>% 
                      melt(id.var=c('yrs','type', 'Asesoria')) 
```


```{r fig.height=2.5,fig.width=5,fig.cap="\\label{Fig2}Índices de biomasa observados (puntos) y estimados (línea) por el modelo de evaluación de stock de anchoveta centro-sur."}

ggplot(data=indobs,aes(x=yrs,y=value/1000000,color=variable))+
  geom_point(aes(color=variable),size=2)+
  geom_line(data=indpred,aes(x=yrs,y=value/1000000,color=variable))+
  xlim(2000,2024)+
  scale_color_manual(name="Índices de biomasa",
                     labels=c("Crucero Verano","Crucero Otoño","Crucero Huevos"),
                     values=c("black","red","green"))+
  ylab("Biomasas (millones de t)")+xlab("Años")+ggtitle("Anchoveta centro-sur")+
  theme_bw(base_size=9.5)

```


```{r}

year<-rep1$years
mph_obs<-rep1$mphobs
mph_pred<-rep1$mphpred
BD_modelo<-rep1$SSB

Data1<-data.frame(year,mph_obs,mph_pred,BD_modelo)
#Data1
```



\newpage

```{r fig.height=2.5,fig.width=5,fig.cap="\\label{Fig2}Comparación de Biomasa desovante estimada por el método de producción diaria de huevos y modelo de evaluación de stock"}

Data2<-Data1%>% melt(id="year")
Data2[Data2==0]<-NA
ggplot(Data2,aes(x=year,y=value/1000000))+xlim(2000,2024)+ylim(NA,1.5)+
  geom_line(aes(color=variable),alpha=.3)+geom_point(aes(color=variable))+
  scale_color_manual(name="Biomasas ",
                     labels=c("BD mpdh observada","BD mpdh predicho","BD modelo"),
                     values=c("green","blue","black"))+
  ylab("Biomasas (millones de t)")+xlab("Años")+ggtitle("Anchoveta centro-sur")+
  theme_bw(base_size=9.5)
```





```{r}

q1<-std1 %>% filter(name=="log_qrecl")
q2<-std1 %>% filter(name=="log_qpela")
q3<-std1 %>% filter(name=="log_qmph")

q_indices<-c(q1$value,q2$value,q3$value)


caption1<-"\\label{tab2}Comparación de coeficiente de capturabilidad estimada por el modelo de evaluación de stock de sardina común para cada índice de biomasa."

datapar<-data.frame(indices=c("Crucero Verano","Crucero Otoño","Crucero Huevos"),
                    dt=c(0.5,0.83,0.16),
                    cv=c(0.3,0.3,100),
                    q=round(exp(q_indices),2))


datapar %>% kbl(booktabs = T,format = "latex",position="h!", align='c',escape=F,
col.names=linebreak(c("Índices de\nbiomasa","dt","CV","Capturabilidad\nq"), align='c'),caption=caption1) %>%  
kable_styling(latex_options = c("striped", "hover","condensed"),
full_width = FALSE,font_size=9)
```

\newpage

```{r}
yearF<-c(2022,2021,2020,2019,2018,2017,2016,2015,2014,2013,2012,2011,2010,2009,2008,2007,2006,2005,2004,2003,2002)
fechainicio<-c("10/09/2022","08/10/2021","27/09/2020","20/08/2019","09/09/2018",
               NA,"06/09/2016","27/09/2015","06/09/2014","27/09/2013",
               "07/10/2012","21/09/2011","10/09/2010","03/09/2009","05/09/2008",
               "29/08/2007",NA,"21/08/2005","21/08/2004","23/08/2003","15/08/2002") %>% as.Date(format="%d/%m/%Y")
fechatermino<-c("12/11/2022","13/11/2021","19/10/2020","28/10/2019","24/10/2018",
                NA,"21/10/2016","27/10/2015","21/10/2014","27/10/2013","29/10/2012",
                "15/10/2011","15/10/2010","05/10/2009","26/09/2008","28/09/2007",
                NA,"22/09/2005","29/09/2004","29/10/2003","12/09/2002")%>% as.Date(format="%d/%m/%Y")

diascrucero<-as.integer(fechatermino-fechainicio)

CVmpdh_var<-rev(c(.289,0.3,.368,.441,NA,.380,1.050,.578,.494,.390,
          1.650,.605,.145,.139,.30,NA,.251,.30,.261,NA,NA))


desove<-rep(0,length(yearF))
for(i in 1:length(yearF)){desove[i]<-paste("01/07/",yearF[i],sep="")}
desove<-as.Date(desove,format="%d/%m/%Y")

iniciodesove<-as.integer(difftime(fechainicio, desove, units = "days"))
fraccionyear<-round(iniciodesove/365,2)

yearBio<-paste(yearF,substr((yearF+1),3,4),sep="-")



dtMPDHvar <- data.frame(yearF,fechainicio,fechatermino,diascrucero,yearBio,fraccionyear)


caption1<-"\\label{tab3}Fechas de inicio, término y duración en días de los cruceros de huevos. Fracción del año biológico considerando la fecha de inicio del crucero"

opts<-options(knitr.kable.NA="-")
dtMPDHvar%>% kbl(booktabs = T,format = "latex",position="h!", align='c',escape=F,caption=caption1,col.names=linebreak(c("Año\nCrucero","Fecha de\ninicio","Fecha de\ntérmino","Duración del\ncrucero","Año\nbiológico","Fracción del\naño biológico (dt)"),align='c'))%>%  
kable_styling(latex_options = c("striped", "hover","condensed"),
full_width = FALSE,font_size=9)

```

```{r fig.height=2.5,fig.width=4,fig.cap="\\label{Fig3}Fracción del año biológico en que comienza el crucero de huevos por año"}
p1<-ggplot(dtMPDHvar,aes(x=yearF,y=diascrucero))+geom_line()+geom_point()+ 
  ylab("Duración del crucero")+xlab("")+theme_bw()
p2<-ggplot(dtMPDHvar,aes(x=yearF,y=fraccionyear))+geom_line()+geom_point()+ 
  ylab("Fracción del año biológico")+xlab("")+theme_bw()
pm<-ggplot(dtMPDHvar,aes(x=yearF,y=fraccionyear))+geom_line()+geom_point()+ 
  ylab("Fracción del año biológico")+xlab("")+theme_bw()
ggarrange(p2,ncol=1,common.legend = T)
```

\newpage

```{=tex}
\begin{figure}[!htb]
\centering
\includegraphics[width=1\textwidth]{Figuras/distribucionEspacialHuevosAnchoveta.png}
\caption{Distribución espacial de huevos de sardina común desde el año 2002 al 2021 (Fuente: Grendi et al 2022 ) .}
\label{Fig4}
\end{figure}
```

\newpage

# Escenarios de sensibilidad del índice de biomasa desovante estimada por el MPDH


```{r}
Casobase<-"CV C.huevos=100, dt_C.huevos=0.16 y bloque_q_C.huevos=0"
S2<-"S1 + dt_C.huevos=variable"
S3<-"S2 + bloque_q_C.huevos=3"
S4<-"S3 + CV C.huevos=0.30"
S5<-"S3 + CV C.huevos=0.15 (alta ponderación)"
S6<-"S3 + CV C.huevos=0.50 (baja ponderación)"
S7<-"S4 + CV C.verano=100 (no aporta información)"
S8<-"S4 + CV C.otoño=100 (no aporta información)"
S9<-"S4 + CV C.verano=0.25 y CV C.otoño=0.15"

tablaEsc<-data.frame("Escenarios"=c("S1","S2","S3","S4","S5","S6","S7","S8","S9"),
                     "Descripción"=c(Casobase,S2,S3,S4,S5,S6,S7,S8,S9))


caption1<-"\\label{tab4}Escenarios de sensibilidad del índice de biomasa desovante estimada por el Método de Producción Diaria de Huevos (MPDH)."

tablaEsc %>%  
  kbl(booktabs = T,format = "latex",position="h!", align='l',
      caption=caption1) %>%  
  kable_styling(latex_options = c("striped", "hover","condensed"),
                full_width = FALSE,font_size=10) %>% 
column_spec(1,italic=T) %>%
  pack_rows(index=c("Caso base "=1,
                    "Cambios en dt_C.huevos y bloque_q_C.huevos"=2,
                    "S3 y Cambios en CV C.huevos"=3,
                    "S4 y Cambios en CV C.verano y C.otoño"=3))


```


\newpage

## Cambios en dt  y bloques de capturabilidad biomasa desovante del índice de biomasa desovante (MPDH)

```{r fig.height=6,fig.width=6}
mpdhplot    <-mpdh_pred[,1:3]%>%data.frame()%>%
  mutate(years=years,index="1. Crucero de huevos",observado=mpdh_obs)%>%melt(id=c("years","index"))
reclasplot  <-reclas_pred[,1:3]%>%data.frame()%>%
  mutate(years=years,index="2. Crucero de verano",observado=reclas_obs)%>%melt(id=c("years","index"))
pelacesplot <-pelaces_pred[,1:3]%>%data.frame()%>%
  mutate(years=years,index="3. Crucero de otoño",observado=pelaces_obs)%>%melt(id=c("years","index"))
Ajustes1<-rbind(mpdhplot,reclasplot,pelacesplot)
#----------------------------------------------------------------------
labelsplot<-c("caso base","dt_mph variable","dt_mph variable y 3 bloques_qmph","Observado")
colorplot<-c("black","red","green","gray")
shapeplot<-c(rep(19,3),21)
linetypeplot<-c(rep("solid",3),"dashed")
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
p1.s1<-ggplot(Ajustes1,aes(x=years,y=value/1000000,color=variable))+
  geom_line(aes(linetype=variable))+
  geom_point(aes(shape=variable),size=2.5)+xlim(2000,2024)+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_shape_manual(name=tittleleg,labels=labelsplot,values=shapeplot)+
  scale_linetype_manual(name=tittleleg,labels=labelsplot,values=linetypeplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_y") + 
  ylab("Biomasa (millones de t)")+xlab("")+theme_bw()
#p1.s1
#----------------------------------------------------------------------
#ggarrange(p1,p2,p3,ncol=1,common.legend = T)
#----------------------------------------------------------------------
```



```{r fig.height=6,fig.width=6}

# MPDH 
mpdh_pred_res<-log(mpdh_pred)[,1:3] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(mpdh_pred_res)[3]<-"Pred"
mpdh_res<-resmph[,1:3]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(mpdh_res)[3]<-"Res"
ResMPH<-merge(mpdh_pred_res,mpdh_res) %>% mutate(index="1. Crucero de huevos")
#RECLAS
recl_pred_res<-log(reclas_pred)[,1:3] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(recl_pred_res)[3]<-"Pred"
recl_res<-resrecl[,1:3]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(recl_res)[3]<-"Res"
ResRECL<-merge(recl_pred_res,recl_res)%>% mutate(index="2. Crucero de verano")
#PELACES
pela_pred_res<-log(pelaces_pred)[,1:3] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(pela_pred_res)[3]<-"Pred"
pela_res<-respela[,1:3]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(pela_res)[3]<-"Res"
ResPELA<-merge(pela_pred_res,pela_res)%>% mutate(index="3. Crucero de otoño")
#BASEDATOS
RESIDUOS<-rbind(ResMPH,ResRECL,ResPELA)

#----------------------------------------------------------------------
labelsplot<-c("caso base","dt_mph variable","dt_mph variable y 3 bloques_qmph")
colorplot<-c("black","red","green")
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
#PLOT
r1.1  <-ggplot(RESIDUOS, aes(yrs,Res,fill=variable)) + xlim(2000,2024)+
  geom_smooth(aes(fill=variable,color=variable),alpha=.1)+
  geom_bar(stat='identity', position='dodge') +
  geom_hline(yintercept = 0) + 
  #geom_text()+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_fill_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_y") + 
  labs(x= 'Año', y = 'Residuales (escala log)') +
  theme_bw(base_size=9.5)

r2.2  <-ggplot(RESIDUOS, aes(Pred,Res,color=variable)) +
  geom_smooth(aes(fill=variable,color=variable),alpha=.1)+
  geom_point(size = 1.5) +
  geom_hline(yintercept = 0) +
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") +
  labs(x= 'Predicho (log)', y = 'Residuales') +
  theme_bw(base_size=9.5)

r4.4 <- ggplot(RESIDUOS, aes(sample = Res,color=variable)) +
  stat_qq() +
  stat_qq_line() +
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") +
  labs(x= 'Sample Quantiles', y ='Theoretical') +
  theme_bw(base_size=9.5)
#-------------------------------------------------------------
#ggarrange(r1.1,r2.2,r4.4,ncol=3,common.legend = T)
#-------------------------------------------------------------
```

```{r fig.height=6,fig.width=9}
ggarrange(p1.s1,r1.1,ncol=2,common.legend = T)
```


```{r}
escRMSE<-c("caso base","dt_mph variable","dt_mph variable y 3 bloques_qmph","cv_mph=0.3","cv_mph=0.15","cv_mph=0.5","cv_reclas=100","cv_pelaces=100","cv_reclas=0.15, cv_pelaces=0.25, cv_mph=0.3")
dataRMSE<-data.frame(Escenarios=escRMSE,C.Huevos=RMSE_mph,C.Verano=RMSE_reclas,C.Otono=RMSE_pelaces)


caption1<-"\\label{tab5}Error cuadrático medio para medir la bondad de ajuste de cada escenario."

dataRMSE[1:3,] %>%  
  kbl(booktabs = T,format = "latex",position="h!", align='l',
      caption=caption1) %>%  
  kable_styling(latex_options = c("striped", "hover","condensed"),
                full_width = FALSE,font_size=10) %>% 
column_spec(1,italic=T) %>% add_header_above(c(' '=1,
                        "RMSE"=3))

```



\newpage
```{r fig.cap="\\label{Fig34}Perfiles de verosimilitud de las fuentes de datos para el parámetro de reclutamiento medio ($R_0$), donde la línea horizontal representa el nivel crítico para el test $\\chi^2$.",fig.height=3.5,fig.width=9}

Rdata_perfils1<-here(dir.Rdata,"PerfilVero_Hito 2s1.RData")
Rdata_perfils2<-here(dir.Rdata,"PerfilVero_Hito 2s2.RData")
Rdata_perfils3<-here(dir.Rdata,"PerfilVero_Hito 2s3.RData")

p1<-fig12.1(Rdata_perfils1,"Caso base",c(30000, 210000))
p2<-fig12.1(Rdata_perfils2,"dt_mph variable",c(30000, 210000))
p3<-fig12.1(Rdata_perfils3,"dt_mph variable y 3 bloques_qmph",c(30000, 210000))

  ggarrange(p1,p2,p3, ncol=3, nrow=1, common.legend= TRUE, legend= "bottom")%>% annotate_figure(left=text_grob("Diferencia % último año",rot=90,size=10))

```


```{r fig.cap="\\label{Fig34}Análisis retrospectivo relativo",fig.height=3.5,fig.width=9}
Rdata_retro1<-here(dir.Rdata,"RetroA_Hito 2a1.RData")
Rdata_retro2<-here(dir.Rdata,"RetroA_Hito 2a2.RData")
Rdata_retro3<-here(dir.Rdata,"RetroA_Hito 2a3.RData")

p1<-fig11.2(Rdata_retro1,ESC="Caso base")
p2<-fig11.2(Rdata_retro2,ESC="dt_mph variable")
p3<-fig11.2(Rdata_retro3,ESC="dt_mph variable y 3 bloques_qmph")

  ggarrange(p1,p2,p3, ncol=3, nrow=1,common.legend = TRUE) %>% annotate_figure(left=text_grob("Diferencia % último año",rot=90,size=10))
  
```



```{r fig.height=3.5,fig.width=9, fig.cap="\\label{Fig35} Variables poblacionales de sardina común"}
BDplot<-BD[,1:3]%>%data.frame()%>%mutate(years=years,index="Biomasa desovante") %>% melt(id=c("years","index"))
Rtplot<-Rt[,1:3]%>%data.frame()%>%mutate(years=years,index="Reclutamientos") %>% melt(id=c("years","index"))
Ftplot<-Ft[,1:3]%>%data.frame()%>%mutate(years=years,index="Mortalidad por pesca") %>% melt(id=c("years","index"))
#----------------------------------------------------------------------
Variables1<-rbind(BDplot,Rtplot,Ftplot)
#----------------------------------------------------------------------
labelsplot<-c("Caso base","dt_mph variable","dt_mph variable y 3 bloques_qmph")
colorplot<-c("black","red","green")
linetypeplot<-c("solid",rep("dashed",2))
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
p1<-ggplot(Variables1,aes(x=years,y=value,color=variable))+geom_line(aes(linetype=variable))+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_linetype_manual(name=tittleleg,labels=labelsplot,values=linetypeplot)+
  facet_wrap(. ~ index, ncol = 3,scales = "free_y") + 
  ylab("")+xlab("")+theme_bw(base_size=9.5)+theme(plot.title = element_text(hjust = 0.5),legend.position="top")
p1
#----------------------------------------------------------------------
```



\newpage
## Cambios en CV mpdh 


```{r fig.height=6,fig.width=6}
mpdhplot<-mpdh_pred[,c(1,4:6)]%>%data.frame()%>%
  mutate(years=years,index="1. Crucero de huevos",observado=mpdh_obs)%>%melt(id=c("years","index"))
reclasplot<-reclas_pred[,c(1,4:6)]%>%data.frame()%>%
  mutate(years=years,index="2. Crucero de verano",observado=reclas_obs)%>%melt(id=c("years","index"))
pelacesplot<-pelaces_pred[,c(1,4:6)]%>%data.frame()%>%
  mutate(years=years,index="3. Crucero de otoño",observado=pelaces_obs)%>%melt(id=c("years","index"))
Ajustes2<-rbind(mpdhplot,reclasplot,pelacesplot)
#----------------------------------------------------------------------
labelsplot<-c("caso base","cv_mph=0.3","cv_mph=0.15","cv_mph=0.5","Observado")
colorplot<-c("black","red","green","blue","gray")
shapeplot<-c(rep(19,4),21)
linetypeplot<-c(rep("solid",4),"dashed")
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
ps2<-ggplot(Ajustes2,aes(x=years,y=value/1000000,color=variable))+
  geom_line(aes(linetype=variable))+
  geom_point(aes(shape=variable),size=2.5)+xlim(2000,2024)+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_shape_manual(name=tittleleg,labels=labelsplot,values=shapeplot)+
  scale_linetype_manual(name=tittleleg,labels=labelsplot,values=linetypeplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_y") + 
  ylab("mpdh")+xlab("")+theme_bw()
#ps2
#----------------------------------------------------------------------
#ggarrange(p1,p2,p3,ncol=1,common.legend = T)
#----------------------------------------------------------------------
```


```{r fig.height=6,fig.width=6}

# MPDH 
mpdh_pred_res<-log(mpdh_pred)[,c(1,4:6)] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(mpdh_pred_res)[3]<-"Pred"
mpdh_res<-resmph[,c(1,4:6)]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(mpdh_res)[3]<-"Res"
ResMPH<-merge(mpdh_pred_res,mpdh_res) %>% mutate(index="1. Crucero de huevos")
#RECLAS
recl_pred_res<-log(reclas_pred)[,c(1,4:6)] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(recl_pred_res)[3]<-"Pred"
recl_res<-resrecl[,c(1,4:6)]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(recl_res)[3]<-"Res"
ResRECL<-merge(recl_pred_res,recl_res)%>% mutate(index="2. Crucero de verano")
#PELACES
pela_pred_res<-log(pelaces_pred)[,c(1,4:6)] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(pela_pred_res)[3]<-"Pred"
pela_res<-respela[,c(1,4:6)]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(pela_res)[3]<-"Res"
ResPELA<-merge(pela_pred_res,pela_res)%>% mutate(index="3. Crucero de otoño")
#BASEDATOS
RESIDUOS<-rbind(ResMPH,ResRECL,ResPELA)

#----------------------------------------------------------------------
labelsplot<-c("caso base","cv_mph=0.3","cv_mph=0.15","cv_mph=0.5")
colorplot<-c("black","red","green","blue")
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
#-------------------------------------------------------------
#PLOT
r1.1  <-ggplot(RESIDUOS, aes(yrs,Res,fill=variable)) + xlim(2000,2024)+
  geom_smooth(aes(fill=variable,color=variable),alpha=.1)+
  geom_bar(stat='identity', position='dodge') +
  geom_hline(yintercept = 0) + 
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_fill_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") + 
  labs(x= 'Año', y = 'Residuales (escala log)') +
  theme_bw(base_size=9.5)

r2.2  <-ggplot(RESIDUOS, aes(Pred,Res,color=variable)) +
  geom_smooth(aes(fill=variable,color=variable),alpha=.1)+
  geom_point(size = 1.5) +
  geom_hline(yintercept = 0) +
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") +
  labs(x= 'Predicho (log)', y = 'Residuales') +
  theme_bw(base_size=9.5)

r4.4 <- ggplot(RESIDUOS, aes(sample = Res,color=variable)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") +
  labs(x= 'Sample Quantiles', y ='Theoretical') +
  theme_bw(base_size=9.5)
#-------------------------------------------------------------
#ggarrange(r1.1,r2.2,r4.4,ncol=3,common.legend = T)
#-------------------------------------------------------------
```


```{r fig.height=6,fig.width=9}
ggarrange(ps2,r1.1,ncol=2,common.legend = T)
```

```{r}
escRMSE<-c("caso base","dt_mph variable","dt_mph variable y 3 bloques_qmph","cv_mph=0.3","cv_mph=0.15","cv_mph=0.5","cv_reclas=100","cv_pelaces=100","cv_reclas=0.15, cv_pelaces=0.25, cv_mph=0.3")
dataRMSE<-data.frame(Escenarios=escRMSE,C.Huevos=RMSE_mph,C.Verano=RMSE_reclas,C.Otono=RMSE_pelaces)


caption1<-"\\label{tab6}Error cuadrático medio para medir la bondad de ajuste de cada escenario."

dataRMSE[c(1,4:6),] %>%  
  kbl(booktabs = T,format = "latex",position="h!", align='l',
      caption=caption1) %>%  
  kable_styling(latex_options = c("striped", "hover","condensed"),
                full_width = FALSE,font_size=10) %>% 
column_spec(1,italic=T) %>% add_header_above(c(' '=2,
                        "RMSE"=3))

```

\newpage

```{r fig.cap="\\label{Fig34}Perfiles de verosimilitud de las fuentes de datos para el parámetro de reclutamiento medio ($R_0$), donde la línea horizontal representa el nivel crítico para el test $\\chi^2$.",fig.height=5,fig.width=9}

Rdata_perfils1<-here(dir.Rdata,"PerfilVero_Hito 2s1.RData")
Rdata_perfils4<-here(dir.Rdata,"PerfilVero_Hito 2s4.RData")
Rdata_perfils5<-here(dir.Rdata,"PerfilVero_Hito 2s5.RData")
Rdata_perfils6<-here(dir.Rdata,"PerfilVero_Hito 2s6.RData")

p1<-fig12.1(Rdata_perfils1,"Caso base",c(30000, 210000))
p2<-fig12.1(Rdata_perfils4,"cv_mph=0.3",c(30000, 210000))
p3<-fig12.1(Rdata_perfils5,"cv_mph=0.15",c(30000, 210000))
p4<-fig12.1(Rdata_perfils6,"cv_mph=0.5",c(30000, 210000))

  ggarrange(p1,p2,p3,p4, ncol=2, nrow=2, common.legend= TRUE, legend= "top")

```



```{r fig.cap="\\label{Fig34}Análisis retrospectivo relativo",fig.height=5,fig.width=9}
Rdata_retro1<-here(dir.Rdata,"RetroA_Hito 2a1.RData")
Rdata_retro4<-here(dir.Rdata,"RetroA_Hito 2a4.RData")
Rdata_retro5<-here(dir.Rdata,"RetroA_Hito 2a5.RData")
Rdata_retro6<-here(dir.Rdata,"RetroA_Hito 2a6.RData")

p1<-fig11.2(Rdata_retro1,ESC="Caso base")
p2<-fig11.2(Rdata_retro4,ESC="cv_mph=0.3")
p3<-fig11.2(Rdata_retro5,ESC="cv_mph=0.15")
p4<-fig11.2(Rdata_retro6,ESC="cv_mph=0.5")

  ggarrange(p1,p2,p3,p4, ncol=2, nrow=2,common.legend = TRUE) %>% annotate_figure(left=text_grob("Diferencia % último año",rot=90,size=10))
  
```


```{r fig.height=3.5,fig.width=9,fig.cap="\\label{Fig35} Variables poblacionales de sardina común"}
BDplot<-BD[,c(1,4:6)]%>%data.frame()%>%mutate(years=years,index="Biomasa desovante") %>% melt(id=c("years","index"))
Rtplot<-Rt[,c(1,4:6)]%>%data.frame()%>%mutate(years=years,index="Reclutamientos") %>% melt(id=c("years","index"))
Ftplot<-Ft[,c(1,4:6)]%>%data.frame()%>%mutate(years=years,index="Mortalidad por pesca") %>% melt(id=c("years","index"))
#----------------------------------------------------------------------
Variables2<-rbind(BDplot,Rtplot,Ftplot)
#----------------------------------------------------------------------
labelsplot<-c("caso base","cv_mph=0.3","cv_mph=0.15","cv_mph=0.5")
colorplot<-c("black","red","green","blue")
linetypeplot<-c("solid",rep("dashed",3))
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
p1<-ggplot(Variables2,aes(x=years,y=value,color=variable))+geom_line(aes(linetype=variable))+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_linetype_manual(name=tittleleg,labels=labelsplot,values=linetypeplot)+
  facet_wrap(. ~ index, ncol = 3,scales = "free_y") + 
  ylab("")+xlab("")+theme_bw(base_size=9.5)+theme(plot.title = element_text(hjust = 0.5),legend.position="top")
p1
```


\newpage

## Cambios en CV reclas y pelaces

```{r fig.height=6,fig.width=6}
mpdhplot<-mpdh_pred[,c(1,7:9)]%>%data.frame()%>%
  mutate(years=years,index="1. Crucero de huevos",observado=mpdh_obs)%>%melt(id=c("years","index"))
reclasplot<-reclas_pred[,c(1,7:9)]%>%data.frame()%>%
  mutate(years=years,index="2. Crucero de verano",observado=reclas_obs)%>%melt(id=c("years","index"))
pelacesplot<-pelaces_pred[,c(1,7:9)]%>%data.frame()%>%
  mutate(years=years,index="3. Crucero de otoño",observado=pelaces_obs)%>%melt(id=c("years","index"))
Ajustes3<-rbind(mpdhplot,reclasplot,pelacesplot)
#----------------------------------------------------------------------
labelsplot<-c("caso base","cv_reclas=100","cv_pelaces=100","cv_reclas=0.15, cv_pelaces=0.25, cv_mph=0.3 ","Observado")
colorplot<-c("black","red","green","blue","gray")
shapeplot<-c(rep(19,4),21)
linetypeplot<-c(rep("solid",4),"dashed")
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
ps3<-ggplot(Ajustes3,aes(x=years,y=value/1000000,color=variable))+
  geom_line(aes(linetype=variable))+
  geom_point(aes(shape=variable),size=2.5)+xlim(2000,2024)+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_shape_manual(name=tittleleg,labels=labelsplot,values=shapeplot)+
  scale_linetype_manual(name=tittleleg,labels=labelsplot,values=linetypeplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_y") + 
  ylab("Biomasa (millones de t)")+xlab("")+theme_bw()

#ps3
#----------------------------------------------------------------------
#ggarrange(p1,p2,p3,ncol=1,common.legend = T)
#----------------------------------------------------------------------
```



```{r fig.height=6,fig.width=6}

# MPDH 
mpdh_pred_res<-log(mpdh_pred)[,c(1,7:9)] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(mpdh_pred_res)[3]<-"Pred"
mpdh_res<-resmph[,c(1,7:9)]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(mpdh_res)[3]<-"Res"
ResMPH<-merge(mpdh_pred_res,mpdh_res) %>% mutate(index="1. Crucero de huevos")
#RECLAS
recl_pred_res<-log(reclas_pred)[,c(1,7:9)] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(recl_pred_res)[3]<-"Pred"
recl_res<-resrecl[,c(1,7:9)]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(recl_res)[3]<-"Res"
ResRECL<-merge(recl_pred_res,recl_res)%>% mutate(index="2. Crucero de verano")
#PELACES
pela_pred_res<-log(pelaces_pred)[,c(1,7:9)] %>% data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(pela_pred_res)[3]<-"Pred"
pela_res<-respela[,c(1,7:9)]%>%data.frame() %>% mutate(yrs=years) %>% melt(id="yrs");names(pela_res)[3]<-"Res"
ResPELA<-merge(pela_pred_res,pela_res)%>% mutate(index="3. Crucero de otoño")
#BASEDATOS
RESIDUOS<-rbind(ResMPH,ResRECL,ResPELA)
#----------------------------------------------------------------------
labelsplot<-c("caso base","cv_reclas=100","cv_pelaces=100","cv_reclas=0.25, cv_pelaces=0.15, cv_mph=0.3")
colorplot<-c("black","red","green","blue")
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
#-------------------------------------------------------------
#PLOT
r1.1  <-ggplot(RESIDUOS, aes(yrs,Res,fill=variable)) + xlim(2000,2024)+
  geom_smooth(aes(fill=variable,color=variable),alpha=.1)+
  geom_bar(stat='identity', position='dodge') +
  geom_hline(yintercept = 0) + 
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_fill_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") + 
  labs(x= 'Año', y = 'Residuales (escala log)') +
  theme_bw(base_size=9.5)

r2.2  <-ggplot(RESIDUOS, aes(Pred,Res,color=variable)) +
  geom_smooth(aes(fill=variable,color=variable),alpha=.1)+
  geom_point(size = 1.5) +
  geom_hline(yintercept = 0) +
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") +
  labs(x= 'Predicho (log)', y = 'Residuales') +
  theme_bw(base_size=9.5)

r4.4 <- ggplot(RESIDUOS, aes(sample = Res,color=variable)) +
  stat_qq() +
  stat_qq_line() +
  facet_wrap(. ~ index, ncol = 1,scales = "free_x") +
  labs(x= 'Sample Quantiles', y ='Theoretical') +
  theme_bw(base_size=9.5)
#-------------------------------------------------------------
#ggarrange(r1.1,r2.2,r4.4,ncol=3,common.legend = T)
#-------------------------------------------------------------
```


```{r fig.height=6,fig.width=9}
ggarrange(ps3,r1.1,ncol=2,common.legend = T)
```

```{r}
escRMSE<-c("caso base","dt_mph variable","dt_mph variable y 3 bloques_qmph","cv_mph=0.3","cv_mph=0.15","cv_mph=0.5","cv_reclas=100","cv_pelaces=100","cv_reclas=0.25, cv_pelaces=0.15, cv_mph=0.3")
dataRMSE<-data.frame(Escenarios=escRMSE,C.Huevos=RMSE_mph,C.Verano=RMSE_reclas,C.Otono=RMSE_pelaces)


caption1<-"\\label{tab6}Error cuadrático medio para medir la bondad de ajuste de cada escenario."

dataRMSE[c(1,7:9),] %>%  
  kbl(booktabs = T,format = "latex",position="h!", align='l',
      caption=caption1) %>%  
  kable_styling(latex_options = c("striped", "hover","condensed"),
                full_width = FALSE,font_size=10) %>% 
column_spec(1,italic=T) %>% add_header_above(c(' '=2,
                        "RMSE"=3))

```

\newpage

```{r fig.cap="\\label{Fig34}Perfiles de verosimilitud de las fuentes de datos para el parámetro de reclutamiento medio ($R_0$), donde la línea horizontal representa el nivel crítico para el test $\\chi^2$.",fig.height=5,fig.width=9}

Rdata_perfils1<-here(dir.Rdata,"PerfilVero_Hito 2s1.RData")
Rdata_perfils7<-here(dir.Rdata,"PerfilVero_Hito 2s7.RData")
Rdata_perfils8<-here(dir.Rdata,"PerfilVero_Hito 2s8.RData")
Rdata_perfils9<-here(dir.Rdata,"PerfilVero_Hito 2s9.RData")

p1<-fig12.1(Rdata_perfils1,"Caso base",c(30000, 210000))
p2<-fig12.1(Rdata_perfils7,"cv_reclas=100",c(30000, 210000))
p3<-fig12.1(Rdata_perfils8,"cv_pelaces=100",c(30000, 210000))
p4<-fig12.1(Rdata_perfils9,"cv_reclas=0.25, cv_pelaces=0.15, cv_mph=0.3",c(30000, 210000))

  ggarrange(p1,p2,p3,p4, ncol=2, nrow=2, common.legend= TRUE, legend= "top")

```


```{r fig.cap="\\label{Fig34}Análisis retrospectivo relativo",fig.height=5,fig.width=9}
# ANALISIS RETROSPECTIVO
source(here(dir.fun,"Fn_Figuras.R"))

Rdata_retro1<-here(dir.Rdata,"RetroA_Hito 2a1.RData")
Rdata_retro7<-here(dir.Rdata,"RetroA_Hito 2a7.RData")
Rdata_retro8<-here(dir.Rdata,"RetroA_Hito 2a8.RData")
Rdata_retro9<-here(dir.Rdata,"RetroA_Hito 2a9.RData")

p1<-fig11.2(Rdata_retro1,ESC="Caso base")
p7<-fig11.2(Rdata_retro7,ESC="cv_reclas=100")
p8<-fig11.2(Rdata_retro8,ESC="cv_pelaces=100")
p9<-fig11.2(Rdata_retro9,ESC="cv_reclas=0.25, cv_pelaces=0.15, cv_mph=0.3")

  ggarrange(p1,p7,p8,p9, ncol=2, nrow=2,common.legend = TRUE) %>% annotate_figure(left=text_grob("Diferencia % último año",rot=90,size=10))
  
```


```{r fig.height=3.5,fig.width=9, fig.cap="\\label{Fig35} Variables poblacionales de sardina común"}
BDplot<-BD[,c(1,7:9)]%>%data.frame()%>%mutate(years=years,index="Biomasa desovante") %>% melt(id=c("years","index"))
Rtplot<-Rt[,c(1,7:9)]%>%data.frame()%>%mutate(years=years,index="Reclutamientos") %>% melt(id=c("years","index"))
Ftplot<-Ft[,c(1,7:9)]%>%data.frame()%>%mutate(years=years,index="Mortalidad por pesca") %>% melt(id=c("years","index"))
#----------------------------------------------------------------------
Variables3<-rbind(BDplot,Rtplot,Ftplot)
#----------------------------------------------------------------------
labelsplot<-c("caso base","cv_reclas=100","cv_pelaces=100","cv_reclas=0.25, cv_pelaces=0.15, cv_mph=0.3 ")
colorplot<-c("black","red","green","blue")
linetypeplot<-c("solid",rep("dashed",3))
tittleleg<-"Escenarios"
#----------------------------------------------------------------------
p1<-ggplot(Variables3,aes(x=years,y=value,color=variable))+geom_line(aes(linetype=variable))+
  scale_color_manual(name=tittleleg,labels=labelsplot,values=colorplot)+
  scale_linetype_manual(name=tittleleg,labels=labelsplot,values=linetypeplot)+
  facet_wrap(. ~ index, ncol = 3,scales = "free_y") + 
  ylab("")+xlab("")+theme_bw(base_size=9.5)+theme(plot.title = element_text(hjust = 0.5),legend.position="top")
p1
```

\newpage

```{r}

data3<-cbind(Datos[,c(1,2,4,6)],mpdh_dens*160)%>% melt(id="year")
data3[data3==0]<-NA

ggplot(data3,aes(x=year,y=log(value)))+xlim(2000,2024)+geom_point(aes(color=variable))+
  geom_smooth(aes(color=variable),alpha=.2)+
  ylab("log(Biomasas)")+xlab("Años")+ggtitle("Anchoveta centro-sur")+
  theme_bw()
  

```
